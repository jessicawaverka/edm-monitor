name: Daily EDM Monitor Fetch

on:
  schedule:
    # 7 AM ET (12:00 UTC) - Morning run
    - cron: '0 12 * * 1-5'
    # 2 PM ET (19:00 UTC) - Afternoon run
    - cron: '0 19 * * 1-5'
  workflow_dispatch:  # Manual trigger

jobs:
  fetch-and-notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install feedparser requests beautifulsoup4 lxml
      
      - name: Run fetch script
        id: fetch
        run: |
          python fetch_data_v10.py
          
          # Count items and high priority
          if [ -f data_draft.csv ]; then
            TOTAL=$(tail -n +2 data_draft.csv | wc -l)
            HIGH=$(grep -i ",high," data_draft.csv | wc -l || echo "0")
            TIER1=$(grep ",1," data_draft.csv | wc -l || echo "0")
            
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "tier1=$TIER1" >> $GITHUB_OUTPUT
            
            # Get high priority titles for email
            HIGH_ITEMS=$(grep -i ",high," data_draft.csv | cut -d',' -f6 | head -5 | sed 's/"//g' || echo "None")
            echo "high_items<<EOF" >> $GITHUB_OUTPUT
            echo "$HIGH_ITEMS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "total=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "tier1=0" >> $GITHUB_OUTPUT
            echo "high_items=None" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit draft data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data_draft.csv data_draft.json || true
          git commit -m "ğŸ“Š Daily data update - ${{ steps.fetch.outputs.total }} items (${{ steps.fetch.outputs.high }} high priority)" || echo "No changes"
          git push || echo "Nothing to push"
      
      - name: Send email notification
        if: steps.fetch.outputs.total != '0'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸš¨ EDM Monitor: ${{ steps.fetch.outputs.total }} new items (${{ steps.fetch.outputs.high }} high priority)"
          to: jessica.waverka@gmail.com
          from: EDM Monitor <edm-monitor@noreply.com>
          body: |
            EDM Monitor Update
            ==================
            
            ğŸ“Š NEW ITEMS FOUND: ${{ steps.fetch.outputs.total }}
            ğŸš¨ HIGH PRIORITY: ${{ steps.fetch.outputs.high }}
            ğŸ›ï¸ TIER 1 (Government): ${{ steps.fetch.outputs.tier1 }}
            
            HIGH PRIORITY ITEMS:
            ${{ steps.fetch.outputs.high_items }}
            
            ---
            
            ğŸ‘‰ REVIEW NOW: https://jessicawaverka.github.io/edm-monitor/review.html
            
            ğŸ“Š DASHBOARD: https://jessicawaverka.github.io/edm-monitor/
            
            ---
            This is an automated alert from your EDM Monitor.
            Runs at 7 AM ET and 2 PM ET, Monday-Friday.
